document.addEventListener('DOMContentLoaded', () => {
    const listContainer = document.getElementById('idea-selection-list');
    const controls = document.getElementById('publisher-controls');
    const notice = document.getElementById('no-selection-notice');
    const ideaTitle = document.getElementById('selected-idea-title');
    const previewBox = document.getElementById('preview-content');
    const trackBtns = document.querySelectorAll('.track-btn');
    const downloadBtn = document.getElementById('download-md-btn');
    const canonizeBtn = document.getElementById('canonize-btn');

    let currentIdea = null;
    let currentTrack = 'scientific';

    // 1. Initial Render: List Ingested Ideas
    function renderList() {
        listContainer.innerHTML = '';
        const ingestedIdeas = NexusData.ideas.filter(i => i.status === 'ingested');

        if (ingestedIdeas.length === 0) {
            listContainer.innerHTML = '<p style="color: rgba(255,255,255,0.3)">No ingested ideas found.</p>';
            return;
        }

        ingestedIdeas.forEach(idea => {
            const item = document.createElement('div');
            item.className = 'selection-item';
            item.innerHTML = `
                <h4>${idea.title}</h4>
                <p>${idea.description}</p>
            `;
            item.onclick = () => selectIdea(idea, item);
            listContainer.appendChild(item);
        });
    }

    // 2. Selection Logic
    function selectIdea(idea, element) {
        currentIdea = idea;

        // UI reset
        document.querySelectorAll('.selection-item').forEach(el => el.classList.remove('active'));
        element.classList.add('active');

        notice.style.display = 'none';
        controls.style.display = 'block';

        ideaTitle.textContent = idea.title;
        updatePreview();
    }

    // 3. Preview Logic
    function updatePreview() {
        if (!currentIdea) return;
        const content = currentIdea.output_tracks[currentTrack];
        previewBox.textContent = content || "No content available for this track.";
    }

    trackBtns.forEach(btn => {
        btn.onclick = () => {
            trackBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentTrack = btn.dataset.track;
            updatePreview();
        };
    });

    // 4. Export Logic (Markdown)
    downloadBtn.onclick = () => {
        if (!currentIdea) return;

        const filename = `${currentIdea.id}_${currentTrack}.md`;
        const content = `# ${currentIdea.title}\n\n## Track: ${currentTrack}\n\n${currentIdea.output_tracks[currentTrack]}\n\n---\n*Generated by Nexus Multi-Track Publisher*`;

        const blob = new Blob([content], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
    };

    // 5. Canonization Logic (UI only for now, would need backend to persist)
    canonizeBtn.onclick = () => {
        if (!currentIdea) return;

        if (confirm(`Are you sure you want to CANONIZE "${currentIdea.title}"?\n\nThis will move it from Ingested to Published status.`)) {
            // In a real app, this would be an API call
            alert(`SUCCESS: "${currentIdea.title}" has been canonized to the Public Baseline.`);

            // Local state update for visual feedback
            currentIdea.status = 'published';
            renderList();
            controls.style.display = 'none';
            notice.style.display = 'flex';
        }
    };

    renderList();
});
